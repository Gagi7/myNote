## JVM参数调优

### 前言

JVM最基础的就是设置堆栈大小的调优

```
-Xms: 初始堆大小
-Xmm: 堆最大值
-Xss: 栈大小
```

> -Xms和-Xmm最好一致，不然可能会频繁回收

我们通过这道问题的引入，详细了解一些JVM的参数

### JVM参数组成

- 标配参数（JDK1-JDK15一直都有的参数）
  - -version
  - -help
  - -showversion
- X参数（与JVM编译启动相关的参数，了解）
  - -Xint：解释执行
  - -Xcomp：直接采用即时编译成机器码执行
  - -Xmixed：两种混合，解释与编译（JIT）共同协作，默认使用
- XX参数（重点）
  - 后一章详细讲解

这里我们简单了解一些JVM的解释与编译

java是跨平台的语言，一次编译，多次执行，其跨平台特性主要靠的是编译

`.java -> .class -> 机器码`

其中最重要的就是.class到机器码，做了解释和编译两件事

- **解释**：可以快速启动执行，省去编译的时间，但是执行效率不高
- **编译**：先把字节码编译成机器码，然后再运行，运行效率高，并且会对代码进行优化

为什么Hotspot虚拟机又使用解释，又使用JIT编译呢？因为在**正常运行时都是使用的解释器**，当某些代码执行次数多于一定条件后，会被认定成**热点代码**，就会启动**JIT编译器编译保存到机器**，这样执行热点代码速度更快。就好像一种**缓存机制**。

## XX参数

### XX参数类型

XX参数类型主要有两种

- Boolean型：XX:+为开启，XX:-为关闭
  - XX:+PrintGCDetails，开启打印GC细节
  - XX:-UseSerialGC，不使用串行收集器
- KV键值对型：-XX:key=value
  - -XX:MetaspaceSize=128m，元空间大小设定
  - -XX:MaxTenuringThreshold=15，多少岁后新生代的对象入住老年代

### 如何查看当前参数的值

也是使用jdk中的自带命令，主要使用以下两个

```
jps -l // 查看java进程号
jinfo -flag 参数名 pid // 查看该参数的值
```

我们先写一个代码使他一直执行，好让我们测试：

```java
public class HelloGC {
    public static void main(String[] args) {
        System.out.println("Hello GC");
        try {
            Thread.sleep(Integer.MAX_VALUE);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }
}
```

![image-20210126153921272](image/image-20210126153921272.png)

可以看到，通过这两个命令，就可以查看运行时的java程序的jvm参数，并针对参数进行调优

并且我们可以直接查看全部的jvm配置：

![image-20210126165041870](image/image-20210126165041870.png)

### 经典参数

我们在学习JVM的时候，知道的一些最经典参数就是，-Xms，-Xmm，-Xss

那么一些面试官就会问你，你说了XX参数有两种类型，Boolean和键值对，那么这三个常用参数属于哪种呢？

回答：X参数类型的 大错特错！

回答：特殊类型 大错特错！

正确回答，其实就是XX参数里的键值对形式，只不过将其简化了：

- -Xms = -XX:InitialHeapSize
- -Xmx =  -XX:MaxHeapSize
- -Xss =  -XX:ThreadStackSize

## 查看JVM默认值

刚刚我们说过，使用`jps`配合`jinfo`就可以查看具体的JVM参数的默认值或全部默认值，但是我们需要自己记住这些参数。

那么还有一种查看默认值也是更加常用的，也是可以查看更多默认值的操作：

```java
// 查看默认JVM参数
java -XX:+PrintFlagsInitial 
```

![image-20210126172758576](image/image-20210126172758576.png)

```java
// 查看修改后的JVM参数
java -XX:+PrintFlagsFinal
```

![image-20210126172952062](image/image-20210126172952062.png)

可以看到，这里有`:=`和`=`之分，`:=`指的是被修改后的值，人为修改或者JVM修改后，`=`是指最初就是这个值

```java
//打印命令行参数(可以看默认垃圾回收器)：
java -XX:+PrintCommandLineFlags
```

![image-20210126175002383](image/image-20210126175002383.png)